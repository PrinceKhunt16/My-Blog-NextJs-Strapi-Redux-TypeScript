import { AxiosResponse } from "axios"
import { GetServerSidePropsContext } from "next"
import { fetchArticleBySlug } from "../../http"
import { IArticle, ICollectionResponse } from "../../types"
import qs from "qs"
import Head from "next/head"
import { formatDate, serializeMarkdown } from "../../utils"
import Image from "next/image"
import { MDXRemote, MDXRemoteSerializeResult } from 'next-mdx-remote';

interface IPropTypes {
    article: IArticle,
    notFound?: boolean
}

export default function Article({ article, notFound = false }: IPropTypes) {
    console.log(article)
    return (
        <>
            <Head>
                <title>{article.attributes.Title}</title>
                <meta
                    name="description"
                    content="Generated by create next app"
                />
                <link rel="icon" href="/favicon.ico" />
            </Head>
            <div className="mb-7 mt-4 grid lg:grid-cols-3 md:grid-cols-2 lg:gap-12 md:gap-0 single-article">
                <div className="lg:col-span-2 md:col-span-2">
                    <h1 className="text-[40px] font-caveatbrush text-gray-600">
                        {article.attributes.Title}
                    </h1>
                    {/* <div className="pt-1">
                        <span className="text-base text-gray-600">
                            {article.attributes.author.data.attributes.firstname}{' '}
                            {article.attributes.author.data.attributes.lastname} On
                            &nbsp;
                            <span className="text-gray-500">
                                {formatDate(article.attributes.createdAt)}
                            </span>
                        </span>
                    </div> */}
                    <div className="text-lg text-gray-600 leading-7">
                        <img
                            className="w-full pt-5"
                            src={`http://localhost:1337${article.attributes.imageurl}`}
                            alt={article.attributes.Title}
                        />
                        <div className="pt-6 mdxremote">
                            <MDXRemote {...(article.attributes.Body) as MDXRemoteSerializeResult} />
                        </div>
                    </div>
                </div>
                <div className="lg:col-span-1 md:col-span-2 pt-7">
                    <div className="p-5 w-full flex flex-col items-center justify-center border border-primary bg-[#53bd9515]">
                        {/* .data.attributes.formats.thumbnail.url */}
                        <div>
                            <Image
                                src={`http://localhost:1337${article.attributes.author.data.attributes.avatarurl}`}
                                alt={article.attributes.Title}
                                height={40}
                                width={40}
                                className="h-40 w-40 border border-primary object-cover rounded-full"
                            />
                        </div>
                        <div>
                            <h1 className="pt-4 font-caveatbrush text-2xl text-center text-gray-600">{article.attributes.author.data.attributes.username}</h1>
                            <h2 className="pt-1 font-caveatbrush text-2xl text-center text-gray-600">{article.attributes.author.data.attributes.email}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </>
    )
}

export async function getServerSideProps(context: GetServerSidePropsContext) {
    const queryString = qs.stringify({
        populate: ['Image', 'author.avatar'],
        filters: {
            Slug: {
                $eq: context.query.article,
            },
        },
    })

    const { data: articles }: AxiosResponse<ICollectionResponse<IArticle[]>> = await fetchArticleBySlug(queryString)

    if (articles.data.length === 0) {
        return {
            notFound: true,
        };
    }

    return {
        props: {
            article: await serializeMarkdown(articles.data[0])
        }
    }
}